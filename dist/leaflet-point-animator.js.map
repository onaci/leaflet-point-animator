{"version":3,"file":"leaflet-point-animator.js","sources":["../src/js/L.CanvasLayer.js","../src/js/L.PointAnimatorLayer.js"],"sourcesContent":["/*\n Generic  Canvas Layer for leaflet 0.7 and 1.0-rc,\n copyright Stanislav Sumbera,  2016 , sumbera.com , license MIT\n originally created and motivated by L.CanvasOverlay  available here: https://gist.github.com/Sumbera/11114288\n\n */\n\n// -- L.DomUtil.setTransform from leaflet 1.0.0 to work on 0.0.7\n//------------------------------------------------------------------------------\nif (!L.DomUtil.setTransform) {\n  L.DomUtil.setTransform = function (el, offset, scale) {\n    var pos = offset || new L.Point(0, 0);\n\n    el.style[L.DomUtil.TRANSFORM] =\n      (L.Browser.ie3d\n        ? \"translate(\" + pos.x + \"px,\" + pos.y + \"px)\"\n        : \"translate3d(\" + pos.x + \"px,\" + pos.y + \"px,0)\") +\n      (scale ? \" scale(\" + scale + \")\" : \"\");\n  };\n}\n\n// -- support for both  0.0.7 and 1.0.0 rc2 leaflet\nL.CanvasLayer = (L.Layer ? L.Layer : L.Class).extend({\n  // -- initialized is called on prototype\n  initialize: function (options) {\n    this._map = null;\n    this._canvas = null;\n    this._frame = null;\n    this._delegate = null;\n    L.setOptions(this, options);\n  },\n\n  delegate: function (del) {\n    this._delegate = del;\n    return this;\n  },\n\n  needRedraw: function () {\n    if (!this._frame) {\n      this._frame = L.Util.requestAnimFrame(this.drawLayer, this);\n    }\n    return this;\n  },\n\n  //-------------------------------------------------------------\n  _onLayerDidResize: function (resizeEvent) {\n    this._canvas.width = resizeEvent.newSize.x;\n    this._canvas.height = resizeEvent.newSize.y;\n  },\n  //-------------------------------------------------------------\n  _onLayerDidMove: function () {\n    var topLeft = this._map.containerPointToLayerPoint([0, 0]);\n    L.DomUtil.setPosition(this._canvas, topLeft);\n    this.drawLayer();\n  },\n  //-------------------------------------------------------------\n  getEvents: function () {\n    var events = {\n      resize: this._onLayerDidResize,\n      moveend: this._onLayerDidMove\n    };\n    if (this._map.options.zoomAnimation && L.Browser.any3d) {\n      events.zoomanim = this._animateZoom;\n    }\n\n    return events;\n  },\n  //-------------------------------------------------------------\n  onAdd: function (map) {\n    this._map = map;\n    this._canvas = L.DomUtil.create(\"canvas\", \"leaflet-layer\");\n    this.tiles = {};\n\n    var size = this._map.getSize();\n    this._canvas.width = size.x;\n    this._canvas.height = size.y;\n\n    var animated = this._map.options.zoomAnimation && L.Browser.any3d;\n    L.DomUtil.addClass(\n      this._canvas,\n      \"leaflet-zoom-\" + (animated ? \"animated\" : \"hide\")\n    );\n\n    this.options.pane.appendChild(this._canvas);\n    map.on(this.getEvents(), this);\n\n    var del = this._delegate || this;\n    del.onLayerDidMount && del.onLayerDidMount(); // -- callback\n    this.needRedraw();\n\n    var self = this;\n    setTimeout(function () {\n      self._onLayerDidMove();\n    }, 0);\n  },\n\n  //-------------------------------------------------------------\n  onRemove: function (map) {\n    var del = this._delegate || this;\n    del.onLayerWillUnmount && del.onLayerWillUnmount(); // -- callback\n    this.options.pane.removeChild(this._canvas);\n    map.off(this.getEvents(), this);\n    this._canvas = null;\n  },\n\n  //------------------------------------------------------------\n  addTo: function (map) {\n    map.addLayer(this);\n    return this;\n  },\n\n  //------------------------------------------------------------------------------\n  drawLayer: function () {\n    // -- todo make the viewInfo properties  flat objects.\n    var size = this._map.getSize();\n    var bounds = this._map.getBounds();\n    var zoom = this._map.getZoom();\n\n    var center = this._map.options.crs.project(this._map.getCenter());\n    var corner = this._map.options.crs.project(\n      this._map.containerPointToLatLng(this._map.getSize())\n    );\n\n    var del = this._delegate || this;\n    del.onDrawLayer &&\n      del.onDrawLayer({\n        layer: this,\n        canvas: this._canvas,\n        bounds: bounds,\n        size: size,\n        zoom: zoom,\n        center: center,\n        corner: corner\n      });\n    this._frame = null;\n  },\n  // -- L.DomUtil.setTransform from leaflet 1.0.0 to work on 0.0.7\n  //------------------------------------------------------------------------------\n  _setTransform: function (el, offset, scale) {\n    var pos = offset || new L.Point(0, 0);\n\n    el.style[L.DomUtil.TRANSFORM] =\n      (L.Browser.ie3d\n        ? \"translate(\" + pos.x + \"px,\" + pos.y + \"px)\"\n        : \"translate3d(\" + pos.x + \"px,\" + pos.y + \"px,0)\") +\n      (scale ? \" scale(\" + scale + \")\" : \"\");\n  },\n\n  //------------------------------------------------------------------------------\n  _animateZoom: function (e) {\n    var scale = this._map.getZoomScale(e.zoom);\n    // -- different calc of offset in leaflet 1.0.0 and 0.0.7 thanks for 1.0.0-rc2 calc @jduggan1\n    var offset = L.Layer\n      ? this._map._latLngToNewLayerPoint(\n        this._map.getBounds().getNorthWest(),\n        e.zoom,\n        e.center\n      )\n      : this._map\n        ._getCenterOffset(e.center)\n        ._multiplyBy(-scale)\n        .subtract(this._map._getMapPanePos());\n\n    L.DomUtil.setTransform(this._canvas, offset, scale);\n  }\n});\n\nL.canvasLayer = function (pane) {\n  return new L.CanvasLayer(pane);\n};\n","import './L.CanvasLayer';\nimport transformWorker from 'web-worker:./transformWorker';\nimport mergeWorker from 'web-worker:./mergeWorker';\n\nconst PointAnimatorLayer = L.Layer.extend({\n\n\t/*------------------------------------ LEAFLET SPECIFIC ------------------------------------------*/\n\n\t_active: false,\n\t_map: null,\n\t_renderer: null,\n\t// the DOM leaflet-pane that contains our layer\n\t_pane: null,\n\t_paneName: 'overlayPane',\n\n\t// must be set explicitly by user\n\t_frameKey: null,\n\n\t// user options\n\toptions: {\n\t\tfeatures: []\n\t},\n\n\tinitialize: function (options) {\n\t\tL.setOptions(this, options);\n\t},\n\n\t/**\n\t * @param map {Object} Leaflet map\n\t */\n\tonAdd: function (map) {\n\t\tthis._active = true;\n\t\tthis._map = map;\n\t\tthis._timeKey = this.options.timeKey || 'time';\n\n\t\tif(!this.options.keyframes && this.options.features) {\n\t\t\tthis._computeKeyframes();\n\t\t} else if (this.options.keyframes) {\n\t\t\tthis._keyframes = this.options.keyframes;\n\t\t\tthis._times = Object.keys(this._keyframes);\n\t\t\tif (this.options.onKeyframesReady) this.options.onKeyframesReady();\n\t\t} else {\n\t\t\tconsole.error('No features or keyframes provided.')\n\t\t}\n\n\t\tthis._setPane();\n\n\t\t// create canvas, add to map pane\t\n\t\tthis._canvasLayer = L.canvasLayer({ pane: this._pane }).delegate(this);\n\t\tthis._canvasLayer.addTo(map);\n\t\tthis._canvas = this._canvasLayer._canvas;\n\t\t\n\t\t// callback\n\t\tif (this.options.onAdd) this.options.onAdd();\n\t},\n\n\t/**\n\t * Remove the pane from DOM, and void pane when layer removed from map\n\t */\n\tonRemove() {\n\t\tthis._active = false;\n\t\tthis._map.removeLayer(this._canvasLayer);\n\t\tif (this.options.onRemove) this.options.onRemove();\n\t},\n\n\t/**\n\t * See: https://github.com/Sumbera/gLayers.Leaflet\n\t * @param {object} info \n\t * @param {object} info.bounds\n\t * @param {object} info.canvas\n\t * @param {object} info.center\n\t * @param {object} info.corner\n\t * @param {object} info.layer\n\t * @param {object} info.size\n\t * @param {number} info.zoom\n\t */\n\tonDrawLayer(info) {\n\t\t\n\t\tvar ctx = info.canvas.getContext('2d');\n\n\t\t// clear entire canvas\n\t\tctx.clearRect(0, 0, info.canvas.width, info.canvas.height);\n\t\t\n\t\tif (!this._frameKey || !this._keyframes) return false;\n\n\t\t// get features for keyframe\n\t\tconst frameFeatures = this._keyframes[this._frameKey];\n\t\tlet radius = 5;\n\n\t\t// draw each point on canvas\n\t\tfor (var i = 0; i < frameFeatures.length; i++) {\n\t\t\t\tvar feature = frameFeatures[i];\n\t\t\t\tconst coords = feature.geometry.coordinates;\n\t\t\t\tif (info.bounds.contains([coords[1], coords[0]])) {\n\n\t\t\t\t\t\t// TODO - more styles\n\t\t\t\t\t\tif(this.options.style) {\n\t\t\t\t\t\t\tconst style = this.options.style(feature);\n\t\t\t\t\t\t\tif (style.fillColor) ctx.fillStyle = style.fillColor;\n\t\t\t\t\t\t\tif (style.color) ctx.strokeStyle = style.color;\n\t\t\t\t\t\t\tif (style.radius) radius = style.radius;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// TODO - default styles\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tconst dot = info.layer._map.latLngToContainerPoint([coords[1], coords[0]]);\n\t\t\t\t\t\tctx.beginPath();\n\t\t\t\t\t\tctx.arc(dot.x, dot.y, radius, 0, Math.PI * 2);\n\t\t\t\t\t\tctx.fill();\n\t\t\t\t\t\tctx.closePath();\n\t\t\t\t}\n\t\t}\n\t},\n\n\t/*------------------------------------ PUBLIC ------------------------------------------*/\n\n\t/**\n\t * check if the particle layer is currently active on the map\n\t * @returns {boolean}\n\t */\n\tisActive() {\n\t\treturn this._active;\n\t},\n\n\t/**\n\t * Get the current frame key\n\t * @returns {string} the keyframe time\n\t */\n\tgetFrame() {\n\t\tif (!this.isActive()) return -1;\n\t\treturn this._frameKey;\n\t},\n\n\t/**\n\t * Get ascending array of available frame keys\n\t * @returns {array} the keyframe time ISO strings\n\t */\n\tgetFrameKeys() {\n\t\treturn this._times.slice();\n\t},\n\n\t/**\n\t * Display the frame at the given frame key\n\t * @param key {string} the keyframe time\n\t */\n\tsetFrame(key) {\n\t\tif (!this.isActive() || !this._keyframes) return;\n\n\t\t// set new if we have target\n\t\tthis._frameKey = key;\n\t\tconst nextFrame = this._keyframes[this._frameKey];\n\t\t\n\t\t// inf invalid, clear the canvas without redraw\n\t\tif (!nextFrame) {\n\t\t\tthis.clearCanvas();\n\t\t\treturn false;\n\t\t}\n\t\tthis.redraw();\n\t},\n\n\t/**\n\t * Wipe the canvas clean\n\t */\n\tclearCanvas() {\n\t\tif (this._canvas) {\n\t\t\tconst ctx = this._canvas.getContext('2d');\n\t\t\tctx.clearRect(0, 0, this._canvas.width, this._canvas.height);\n\t\t}\n\t},\n\n\t/**\n\t * Trigger a redraw of the canvas layer\n\t */\n\tredraw() {\n\t\tif (this.isActive() && this._canvasLayer) this._canvasLayer.needRedraw();\n\t},\n\n\t/*------------------------------------ PRIVATE ------------------------------------------*/\n\n\t/**\n\t * Kick off worker job/s to compute keyframes from features.\n\t */\n\t_computeKeyframes() {\n\n\t\tconst numWorkers = this.options.numWorkers || window.navigator.hardwareConcurrency;\n\t\t\n\t\t// split features into chunks for worker\n\t\tconst featureChunks = this._chunkArray(this.options.features, numWorkers);\n\t\t\n\t\tlet running = 0;\n\t\tconst keyframeArray = [];\n\n\t\tconst workerDone = (e) => {\n\t\t\trunning -= 1;\n\t\t\tkeyframeArray.push(e.data.keyframes);\n\t\t\tif(running < 1) {\n\t\t\t\tconst mWorker = new mergeWorker();\n\t\t\t\tmWorker.postMessage({ keyframeArray });\n\t\t\t\tmWorker.onmessage = (e) => {\n\t\t\t\t\t\tthis._keyframes = e.data.keyframes;\n\t\t\t\t\t\tconsole.log('this._keyframes', this._keyframes);\n\t\t\t\t\t\n\t\t\t\t\t\tthis._times = Object.keys(this._keyframes);\n\t\t\t\t\t\tif (this.options.onKeyframesReady) {\n\t\t\t\t\t\t\tthis.options.onKeyframesReady();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\t\n\t\t\t\t\t\t\t\n\t\t\t}\n\t\t}\n\n    for(let i = 0; i < numWorkers; i += 1) {\n      running += 1;\n      const tWorker = new transformWorker();\n      tWorker.onmessage = workerDone;\n      tWorker.postMessage({ features: featureChunks[i], timeKey: this._timeKey });\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\t\n\t},\n\n\t/**\n\t * Create custom pane if necessary\n\t * @private\n\t */\n\t_setPane() {\n\t\t// determine where to add the layer\n\t\tthis._paneName = this.options.paneName || 'overlayPane';\n\n\t\t// fall back to overlayPane for leaflet < 1\n\t\tlet pane = this._map._panes.overlayPane\n\t\tif (this._map.getPane) {\n\t\t\t// attempt to get pane first to preserve parent (createPane voids this)\n\t\t\tpane = this._map.getPane(this._paneName);\n\t\t\tif (!pane) {\n\t\t\t\tpane = this._map.createPane(this._paneName);\n\t\t\t}\n\t\t}\n\n\t\tthis._pane = pane;\n\t},\n\n\t/**\n\t * Divide an array into n chunks\n\t * @param {array} array \n\t * @param {number} parts \n\t */\n\t_chunkArray(array, parts) {\n\t\tlet result = [];\n\t\tfor (let i = parts; i > 0; i--) {\n\t\t\t\tresult.push(array.splice(0, Math.ceil(array.length / i)));\n\t\t}\n\t\treturn result;\n\t}\n\n});\n\nL.pointAnimatorLayer = function (options) {\n\treturn new PointAnimatorLayer(options);\n};\n\nexport default L.pointAnimatorLayer;\n\n\n"],"names":["L","DomUtil","setTransform","el","offset","scale","pos","Point","style","TRANSFORM","Browser","ie3d","x","y","CanvasLayer","Layer","Class","extend","initialize","options","_map","_canvas","_frame","_delegate","setOptions","delegate","del","needRedraw","Util","requestAnimFrame","drawLayer","_onLayerDidResize","resizeEvent","width","newSize","height","_onLayerDidMove","topLeft","containerPointToLayerPoint","setPosition","getEvents","events","resize","moveend","zoomAnimation","any3d","zoomanim","_animateZoom","onAdd","map","create","tiles","size","getSize","animated","addClass","pane","appendChild","on","onLayerDidMount","self","setTimeout","onRemove","onLayerWillUnmount","removeChild","off","addTo","addLayer","bounds","getBounds","zoom","getZoom","center","crs","project","getCenter","corner","containerPointToLatLng","onDrawLayer","layer","canvas","_setTransform","e","getZoomScale","_latLngToNewLayerPoint","getNorthWest","_getCenterOffset","_multiplyBy","subtract","_getMapPanePos","canvasLayer","PointAnimatorLayer","_active","_renderer","_pane","_paneName","_frameKey","features","_timeKey","timeKey","keyframes","_computeKeyframes","_keyframes","_times","Object","keys","onKeyframesReady","console","error","_setPane","_canvasLayer","removeLayer","info","ctx","getContext","clearRect","frameFeatures","radius","i","length","feature","coords","geometry","coordinates","contains","fillColor","fillStyle","color","strokeStyle","dot","latLngToContainerPoint","beginPath","arc","Math","PI","fill","closePath","isActive","getFrame","getFrameKeys","slice","setFrame","key","nextFrame","clearCanvas","redraw","numWorkers","window","navigator","hardwareConcurrency","featureChunks","_chunkArray","running","keyframeArray","workerDone","push","data","mWorker","mergeWorker","postMessage","onmessage","log","tWorker","transformWorker","paneName","_panes","overlayPane","getPane","createPane","array","parts","result","splice","ceil","pointAnimatorLayer"],"mappings":"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"}